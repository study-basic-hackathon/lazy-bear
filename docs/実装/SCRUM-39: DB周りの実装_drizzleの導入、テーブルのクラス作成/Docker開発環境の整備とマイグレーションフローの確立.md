# Docker開発環境の整備とマイグレーションフローの確立

## 1. 背景

マイグレーションについて、以下について個人的に気になった。
- Dockerの世界にNext.jsとDBがあるけど、マイグレーションコマンドの実行がDockerの外からなので、本番反映してもローカルのソースコードを使ってマイグレすることになる（GitHub Actionsとかで自動化とかが難しくなる）
    - `app/drizzle.config.ts`にて、`process.loadEnvFile("../.env");`とすると、コンテナの中にない.envを見に行くことになってしまう
    - `.env`で`POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`を設定しているのに、別で`DATABASE_URL`を設定する必要が出てくる
- `README.md`に二つのコマンド: `db:generate`と`db:migrate`が出てくるが、`db:generate`の実施タイミングを明記した方が良いと感じた（`db:generate`で作られるマイグレーションファイルはGitで共有し、プルした人では行わない方が良いという意図）
- （マイグレーションと直接関係なし）プログラムを修正するたびに`docker compose up -d --build`を実施する必要があったので、ローカルとDockerのファイルを同期させたかった。

これらの問題を解決し、誰でも再現性高く、安定して開発できる環境を構築するため、開発ワークフローをDockerコンテナ経由に完全に統一する修正を行った。

## 2. 実施内容

### 2.1. `README.md` の更新

- **データベースマイグレーションの手法変更:**
    - ローカルから`db:migrate`をするのではなく、dockerコンテナを経由してコマンドを実行（`docker compose exec app`）に書き換えた。
    - スキーマを変更する担当者 (`db:generate` を実行) と、変更を取り込む開発者 (`db:migrate` のみ実行) の役割を明確に分離した。

- **セットアップ手順の修正:** 章立て番号を修正。

### 2.2. `drizzle.config.ts` の修正

- Dockerコンテナでは参照できなくなる `.env` ファイルの読み込み処理 (`process.loadEnvFile(...)`) を削除した。
コンテナには、環境変数は `docker-compose.yml` から渡されるため、この処理は不要になる。

### 2.3. `docker-compose.yml` の修正

- **ソースコードの同期:** ローカルの `app` ディレクトリをコンテナの `/app` にマウントし、コード変更が即時反映されるようにした。
- **`node_modules` の分離:** 上記のコマンドでローカルのホストの`app` ディレクトリがすべてコンテナの `/app` にマウントされるが、`node_modules` だけはコンテナと共有しないように、匿名ボリュームを使ってコンテナ専用の `node_modules` を利用する設定を追加した。

```yaml
# 修正後 (appサービス抜粋)
    volumes:
      - ./app:/app
      - /app/node_modules
      - ~/.config/gcloud:/root/.config/gcloud:ro
```



### 2.4. `.env.example` の修正

- Dockerコンテナ内では使用されない `DATABASE_URL` の記述を削除し、設定をシンプルにした。



## 3. 開発ワークフローをDockerに統一するメリット・デメリット

### 3.1. メリット

- **環境の完全な統一:** 開発者全員がOSに関わらず、全く同じ環境で開発できるため、「自分のPCでは動いた」といった問題を根本から解決できる。
- **セットアップの簡略化:** 新しいメンバーはDockerをインストールするだけで、すぐに開発環境を構築できる。
- **本番環境との整合性:** 開発環境と本番環境の差異が小さくなり、デプロイ時のリスクを低減できる。
- **PC環境のクリーン化:** プロジェクト固有の依存関係（Node.js, DBのバージョン等）をPC本体にインストールする必要がなく、環境をクリーンに保てる。

### 3.2. デメリット

- **Dockerの学習コスト:** Dockerに不慣れな開発者には、初期の学習コストがかかる場合がある。
- **パフォーマンス:** ネイティブ実行に比べ、わずかなパフォーマンスオーバーヘッドが存在するが、近年のDockerの性能向上により、開発体験への影響は軽微。

## 4. 結論

デメリットもありますが、コンテナのメリットを活かせるかと思ってこのようにしてみました。
