# Cloud Run デプロイ計画 (2025/09/19)

前回のインフラ構築作業 (`deployment_status_20250917.md`) と、本日確認した懸念点 (`20250919.km`) を踏まえ、Cloud Runへのアプリケーションデプロイを完了させるためのタスクプラン。

## 本日のゴール
- **Next.jsアプリケーションをCloud Run上で正常に稼働させる。**
- 特に、アプリケーションがVertex AIの機能を呼び出せる権限問題を解決する。

---

## 作業ステップ

### Step 1: 【Terraform】IAMサービスアカウントの整備
**目的:** Cloud Runで実行されるアプリケーションがVertex AIを呼び出すための適切な権限を持つようにする。

1.  **サービスアカウントの作成:**
    -   `terraform`ディレクトリに`iam.tf`のようなファイルを作成し、Cloud Run用の`google_service_account`リソースを定義する。

2.  **IAMロールの付与:**
    -   作成したサービスアカウントに対し、Vertex AIを利用するためのIAMロール (`roles/aiplatform.user`) を`google_project_iam_member`リソースを使って付与する。

3.  **Cloud Runサービスへの紐付け:**
    -   `cloud_run.tf`を修正し、`google_cloud_run_v2_service`リソースの定義に、作成したサービスアカウントを指定する (`template.service_account`)。

4.  **インフラの適用:**
    -   `terraform apply`を実行し、上記変更をGCPインフラに反映させる。

### Step 2: 【Docker】本番用Dockerfileの作成
**目的:** 開発用とは別に、本番環境に最適化された軽量でセキュアなDockerイメージをビルドできるようにする。

1.  **Dockerfileの作成:**
    -   `app/`ディレクトリに`Dockerfile.prod`という名前で、本番用のDockerfileを新規作成する。
    -   Next.jsの[公式ドキュメント](https://nextjs.org/docs/pages/building-your-application/deploying/docker)を参考に、マルチステージビルドを実装する。
        -   **Builderステージ:** 依存関係のインストールとアプリケーションのビルド (`npm run build`)。
        -   **Runnerステージ:** Builderステージからビルド成果物 (`.next`, `public`, `node_modules`等) のみをコピーし、本番サーバーを起動 (`npm run start`)。

### Step 3: 【Docker】イメージのビルドとプッシュ
**目的:** 作成した本番用Dockerfileを基にアプリケーションのイメージをビルドし、GCPのArtifact Registryに登録する。

1.  **イメージのビルド:**
    ```bash
    # app/ ディレクトリで実行
    docker build . -f Dockerfile.prod -t asia-northeast1-docker.pkg.dev/lazy-bear-471016/lazy-bear-repo/lazy-bear-app:latest
    ```

2.  **Artifact Registryへのプッシュ:**
    ```bash
    docker push asia-northeast1-docker.pkg.dev/lazy-bear-471016/lazy-bear-repo/lazy-bear-app:latest
    ```

### Step 4: 【Cloud Run】アプリケーションのデプロイと確認
**目的:** 最新のDockerイメージをCloud Runにデプロイし、最終的な動作を確認する。

1.  **Cloud Runサービスの更新:**
    ```bash
    # terraform/ ディレクトリで実行
    gcloud run deploy lazy-bear-app \
      --image asia-northeast1-docker.pkg.dev/lazy-bear-471016/lazy-bear-repo/lazy-bear-app:latest \
      --region asia-northeast1 \
      --platform managed
    ```

2.  **動作確認:**
    -   デプロイされたURL (`terraform output cloud_run_service_url`) にアクセスする。
    -   学習計画の生成など、Vertex AIを利用する機能が正常に動作することを重点的に確認する。

---

## 今後の課題 (優先度: 低)
- **DBマイグレーションの自動化:**
  -   `package.json`にマイグレーション用のスクリプト (`"db:migrate"`) を追加する。
  -   マイグレーションを実行するための専用のCloud RunジョブをTerraformで定義する。
